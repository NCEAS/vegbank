<?xml version="1.0"?>
<!-- 
  * build.xml
  *
  * Global build script for vegclass. This simply allows running all the sub 
  * scripts from one place.
  *
  *     '$Author: farrell $'
  *     '$Date: 2003-03-21 23:38:51 $'
  *     '$Revision: 1.7 $'
--> 
<project name="vegclass" default="compile" basedir=".">


  <target name="prepare">
    <property environment="env" />
    <property name="build.dir" value="${basedir}/build"/>
    <property name="build.src.dir" value="${build.dir}/src"/>
    <property name="build.sql.dir" value="${build.src.dir}/sql"/>
    <property name="build.reports.dir" value="${build.dir}/reports"/>
    <property name="build.reports.test.dir" value="${build.reports.dir}/testreports"/>
    <property name="docs.dir" value="${basedir}/docs"/>
    <property name="bin.dir" value="${basedir}/bin"/>
    <property name="src.dir" value="${basedir}/src"/>
    <property name="xsl.src.dir" value="${src.dir}/xsl"/>
    <property name="ant.style.dir" location="${env.ANT_HOME}/etc" />
    <property name="web.docroot" location="${env.TOMCAT_HOME}/webapps" />
       
    <property name="plants.db.name" value="plants_dev" />
    <property name="plots.db.name" value="plots_dev" />
    <property name="communities.db.name" value="communities_dev" />
    
    <mkdir dir="${build.src.dir}"/>
    <mkdir dir="${build.sql.dir}"/>
    <mkdir dir="${build.reports.dir}"/>
    <mkdir dir="${build.reports.test.dir}"/>
  </target>
    
  <target name="jar" depends="prepare"
          description="==> Generates all jars in vegclass module">
    
    <ant dir="common" target="jar" inheritAll="false"/>
    <ant dir="veg_community" target="jar" inheritAll="false"/>
    <ant dir="veg_taxa" target="jar" inheritAll="false"/>
    <ant dir="veg_plot" target="jar" inheritAll="false"/>
    
  </target>

  <target name="run-tests" description="==> Run all the tests availible">
    <ant dir="veg_plot" target="run-tests" inheritAll="false"/> 
    <ant dir="common" target="test" inheritAll="false"/>
    <ant dir="veg_taxa" target="test" inheritAll="false"/>
  </target>
  
  <target name="deploy" depends="jar"
          description="==> deploys vegclass module jars, html and other resources">
    
    <ant dir="common" target="deploy" inheritAll="false"/>
    <ant dir="veg_community" target="deploy" inheritAll="false"/>
    <ant dir="veg_taxa" target="deploy" inheritAll="false"/>
    <ant dir="veg_plot" target="deploy" inheritAll="false"/>
  
  </target>

	<target name="clean" description="==> Remove all generated files">
    <ant dir="common" target="clean" inheritAll="false"/>
    <ant dir="veg_plot" target="clean" inheritAll="false"/>
    <ant dir="veg_community" target="clean" inheritAll="false"/>
    <ant dir="veg_taxa" target="clean" inheritAll="false"/>
  </target>

  <target name="dist-reports" 
          depends="prepare"
          description="==> Generate htmls from generated reports and distributes to web">

		<!-- Create a report from the junit output -->
		<junitreport todir="${build.reports.test.dir}">
	  		<fileset dir="${build.reports.test.dir}">
	  			<include name="TEST-*.xml"/>
			</fileset>
	  		<report format="frames"
				        todir="${web.docroot}/vegbank/dev/reports/junit"
	              styledir="${ant.style.dir}"/>
	  	</junitreport>
	
	</target>

  <!-- ================================================================= -->
  <!-- Database related targets                                          -->
  <!-- ================================================================= -->

  <target name="db_generate_sql"
          description="==> Generate the sql build scripts"
          depends="prepare">
          
    <xslt in="${docs.dir}/xml/db_model_vegbank.xml" out="${build.sql.dir}/plot.sql" 
          style="${xsl.src.dir}/VegBankModel2SQL.xsl">
      <param name="module" expression="plot"/>
    </xslt>
    
    <xslt in="${docs.dir}/xml/db_model_vegbank.xml" out="${build.sql.dir}/plant.sql" 
          style="${xsl.src.dir}/VegBankModel2SQL.xsl">
      <param name="module" expression="plant"/>
    </xslt>
    
    <xslt in="${docs.dir}/xml/db_model_vegbank.xml" out="${build.sql.dir}/community.sql" 
          style="${xsl.src.dir}/VegBankModel2SQL.xsl">
      <param name="module" expression="community"/>
    </xslt>
    
  </target>


  <target name="db_rebuild_plants"
          description="==> Rebuild the plants Database"
          depends="db_generate_sql">
    <!-- DROP and CREATE Database -->
    <exec executable="${bin.dir}/rebuilddb.sh">
      <arg value="${plants.db.name}"/>
      <arg value="${build.sql.dir}/plant.sql"/>
    </exec>
    
    
  </target>
  
  <target name="db_rebuild_plots"
          description="==> Rebuild the plots Database"
          depends="db_generate_sql">
    <exec executable="${bin.dir}/rebuilddb.sh">
      <arg value="${plots.db.name}"/>
      <arg value="${build.sql.dir}/plot.sql"/>
    </exec>
  </target>
  
  <target name="db_rebuild_communities"
          description="==> Rebuild the communities Database"
          depends="db_generate_sql">
    <exec executable="${bin.dir}/rebuilddb.sh">
      <arg value="${communities.db.name}"/>
      <arg value="${build.sql.dir}/community.sql"/>
    </exec>
  </target>
  
  <target name="db_rebuild_all"
          description="==> Rebuild all the Databases"
          depends="db_rebuild_plots, db_rebuild_plants, db_rebuild_communities">
  </target>

  
</project>
